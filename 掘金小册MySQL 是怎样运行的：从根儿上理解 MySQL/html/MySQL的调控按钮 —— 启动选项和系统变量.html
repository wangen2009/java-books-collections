<h1 class="heading">启动选项和配置文件</h1>
<p>标签： MySQL 是怎样运行的</p>
<hr>
<p>如果你用过手机，你的手机上一定有一个设置的功能，你可以选择设置手机的来电铃声、设置音量大小、设置解锁密码等等。假如没有这些设置功能，我们的生活将置于尴尬的境地，比如在图书馆里无法把手机设置为静音，无法把流量开关关掉以节省流量，在别人得知解锁密码后无法更改密码～ <code>MySQL</code>的服务器程序和客户端程序也有很多设置项，比如对于<code>MySQL</code>服务器程序，我们可以指定诸如允许同时连入的客户端数量、客户端和服务器通信方式、表的默认存储引擎、查询缓存的大小吧啦吧啦的设置项。对于<code>MySQL</code>客户端程序，我们之前已经见识过了，可以指定需要连接的服务器程序所在主机的主机名或IP地址、用户名及密码等信息。</p>
<p>这些设置项一般都有各自的默认值，比方说服务器允许同时连入的客户端的默认数量是<code>151</code>，表的默认存储引擎是<code>InnoDB</code>，我们可以在程序启动的时候去修改这些默认值，对于这种在程序启动时指定的设置项也称之为启动选项（startup options），这些选项控制着程序启动后的行为。在<code>MySQL</code>安装目录下的<code>bin</code>目录中的各种可执行文件，不论是服务器相关的程序（比如<code>mysqld</code>、<code>mysqld_safe</code>）还是客户端相关的程序（比如<code>mysql</code>、<code>mysqladmin</code>），在启动的时候基本都可以指定启动参数。这些启动参数可以放在命令行中指定，也可以把它们放在配置文件中指定。下边我们会以<code>mysqld</code>为例，来详细唠叨指定启动选项的格式。需要注意的一点是，我们现在要唠叨的是设置启动选项的方式，下边出现的启动选项不论大家认不认识，先不用去纠结每个选项具体的作用是啥，之后我们会对一些重要的启动选项详细唠叨。</p>
<h4 class="heading">在命令行上使用选项</h4>
<p>如果我们在启动客户端程序时在<code>-h</code>参数后边紧跟服务器的IP地址，这就意味着客户端和服务器之间需要通过<code>TCP/IP</code>网络进行通信。因为我的客户端程序和服务器程序都装在一台计算机上，所以在使用客户端程序连接服务器程序时指定的主机名是<code>127.0.0.1</code>的情况下，客户端进程和服务器进程之间会使用<code>TCP/IP</code>网络进行通信。如果我们在启动服务器程序的时候就禁止各客户端使用<code>TCP/IP</code>网络进行通信，可以在启动服务器程序的命令行里添加<code>skip-networking</code>启动选项，就像这样：</p>
<pre><code class="hljs bash" lang="bash">mysqld --skip-networking
</code></pre><p>可以看到，我们在命令行中指定启动选项时需要在选项名前加上<code>--</code>前缀。另外，如果选项名是由多个单词构成的，它们之间可以由短划线<code>-</code>连接起来，也可以使用下划线<code>_</code>连接起来，也就是说<code>skip-networking</code>和<code>skip_networking</code>表示的含义是相同的。所以上边的写法与下边的写法是等价的：</p>
<pre><code class="hljs bash" lang="bash">mysqld --skip_networking
</code></pre><p>在按照上述命令启动服务器程序后，如果我们再使用<code>mysql</code>来启动客户端程序时，再把服务器主机名指定为<code>127.0.0.1</code>（IP地址的形式）的话会显示连接失败：</p>
<pre><code class="hljs bash" lang="bash"> mysql -h127.0.0.1 -uroot -p
Enter password:

ERROR 2003 (HY000): Can<span class="hljs-string">'t connect to MySQL server on '</span>127.0.0.1<span class="hljs-string">' (61)
</span></code></pre><p>这就意味着我们指定的启动选项<code>skip-networking</code>生效了！</p>
<p>再举一个例子，我们前边说过如果在创建表的语句中没有显式指定表的存储引擎的话，那就会默认使用<code>InnoDB</code>作为表的存储引擎。如果我们想改变表的默认存储引擎的话，可以这样写启动服务器的命令行：</p>
<pre><code class="hljs bash" lang="bash">mysqld --default-storage-engine=MyISAM
</code></pre><p>我们现在就已经把表的默认存储引擎改为<code>MyISAM</code>了，在客户端程序连接到服务器程序后试着创建一个表：</p>
<pre><code class="hljs bash" lang="bash">mysql&gt; CREATE TABLE sys_var_demo(
    -&gt;     i INT
    -&gt; );
Query OK, 0 rows affected (0.02 sec)
</code></pre><p>这个定义语句中我们并没有明确指定表的存储引擎，创建成功后再看一下这个表的结构：</p>
<pre><code class="hljs bash" lang="bash">mysql&gt; SHOW CREATE TABLE sys_var_demo\G
*************************** 1. row ***************************
       Table: sys_var_demo
Create Table: CREATE TABLE `sys_var_demo` (
  `i` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)
</code></pre><p>可以看到该表的存储引擎已经是<code>MyISAM</code>了，说明启动选项<code>default-storage-engine</code>生效了。</p>
<p>所以在启动服务器程序的命令行后边指定启动选项的通用格式就是这样的：</p>
<pre><code class="hljs bash" lang="bash">--启动选项1[=值1] --启动选项2[=值2] ... --启动选项n[=值n]
</code></pre><p>也就是说我们可以将各个启动选项写到一行中，各个启动选项之间使用空白字符隔开，在每一个启动选项名称前边添加<code>--</code>。对于不需要值的启动选项，比方说<code>skip-networking</code>，它们就不需要指定对应的值。对于需要指定值的启动选项，比如<code>default-storage-engine</code>我们在指定这个设置项的时候需要显式的指定它的值，比方说<code>InnoDB</code>、<code>MyISAM</code>啦什么的～ 在命令行上指定有值的启动选项时需要注意，<span style="color:red">选项名、=、选项值之间不可以有空白字符</span>，比如写成下边这样就是不正确的：</p>
<pre><code class="hljs bash" lang="bash">mysqld --default-storage-engine = MyISAM

</code></pre><p><span style="color:red">每个MySQL程序都有许多不同的选项。大多数程序提供了一个--help选项，你可以查看该程序支持的全部启动选项以及它们的默认值</span>。例如，使用<code>mysql --help</code>可以看到<code>mysql</code>程序支持的启动选项，<code>mysqld_safe --help</code>可以看到<code>mysqld_safe</code>程序支持的启动选项。查看<code>mysqld</code>支持的启动选项有些特别，需要使用<code>mysqld --verbose --help</code>。</p>
<h5 class="heading">选项的长形式和短形式</h5>
<p>我们前边提到的<code>skip-networking</code>、<code>default-storage-engine</code>称之为长形式的选项（因为它们很长），设计<code>MySQL</code>的大叔为了我们使用的方便，对于一些常用的选项提供了短形式，我们列举一些具有短形式的启动选项来瞅瞅（<code>MySQL</code>支持的短形式选项太多了，全列出来会刷屏的）：</p>
<table>
<thead>
<tr>
<th style="text-align:center">长形式</th>
<th style="text-align:center">短形式</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>--host</code></td>
<td style="text-align:center"><code>-h</code></td>
<td style="text-align:left">主机名</td>
</tr>
<tr>
<td style="text-align:center"><code>--user</code></td>
<td style="text-align:center"><code>-u</code></td>
<td style="text-align:left">用户名</td>
</tr>
<tr>
<td style="text-align:center"><code>--password</code></td>
<td style="text-align:center"><code>-p</code></td>
<td style="text-align:left">密码</td>
</tr>
<tr>
<td style="text-align:center"><code>--port</code></td>
<td style="text-align:center"><code>-P</code></td>
<td style="text-align:left">端口</td>
</tr>
<tr>
<td style="text-align:center"><code>--version</code></td>
<td style="text-align:center"><code>-V</code></td>
<td style="text-align:left">版本信息</td>
</tr>
</tbody>
</table>
<p>短形式的选项名只有一个字母，与使用长形式选项时需要在选项名前加两个短划线<code>--</code>不同的是，使用短形式选项时在选项名前只加一个短划线<code>-</code>前缀。有一些短形式的选项我们之前已经接触过了，比方说我们在启动服务器程序时指定监听的端口号：</p>
<pre><code class="hljs bash" lang="bash">mysqld -P3307
</code></pre><p>使用短形式指定启动选项时，选项名和选项值之间可以没有间隙，或者用空白字符隔开（<code>-p</code>选项有些特殊，<code>-p</code>和密码值之间不能有空白字符），也就是说上边的命令形式和下边的是等价的：</p>
<pre><code class="hljs bash" lang="bash">mysqld -P 3307
</code></pre><p>另外，选项名是区分大小写的，比如<code>-p</code>和<code>-P</code>选项拥有完全不同的含义，大家需要注意一下。</p>
<h4 class="heading">配置文件中使用选项</h4>
<p>在命令行中设置启动选项只对当次启动生效，也就是说如果下一次重启程序的时候我们还想保留这些启动选项的话，还得重复把这些选项写到启动命令行中，这样真的神烦唉！于是设计<code>MySQL</code>的大叔们提出一种<code>配置文件</code>（也称为<code>选项文件</code>）的概念，我们把需要设置的启动选项都写在这个配置文件中，每次启动服务器的时候都从这个文件里加载相应的启动选项。由于这个配置文件可以长久的保存在计算机的硬盘里，所以只需我们配置一次，以后就都不用显式的把启动选项都写在启动命令行中了，<span style="color:red">所以我们推荐使用配置文件的方式来设置启动选项</span>。</p>
<h5 class="heading">配置文件的路径</h5>
<p><code>MySQL</code>程序在启动时会寻找多个路径下的配置文件，这些路径有的是固定的，有的是可以在命令行指定的。根据操作系统的不同，配置文件的路径也有所不同，我们分开看一下。</p>
<h6 class="heading">Windows操作系统的配置文件</h6>
<p>在<code>Windows</code>操作系统中，<code>MySQL</code>会按照下列路径来寻找配置文件：</p>
<table>
<thead>
<tr>
<th>路径名</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>%WINDIR%\my.ini</code>， <code>%WINDIR%\my.cnf</code></td>
<td></td>
</tr>
<tr>
<td><code>C:\my.ini</code>， <code>C:\my.cnf</code></td>
<td></td>
</tr>
<tr>
<td><code>BASEDIR\my.ini</code>， <code>BASEDIR\my.cnf</code></td>
<td></td>
</tr>
<tr>
<td><code>defaults-extra-file</code></td>
<td>命令行指定的额外配置文件路径</td>
</tr>
<tr>
<td><code>%APPDATA%\MySQL\.mylogin.cnf</code></td>
<td>登录路径选项（仅限客户端）</td>
</tr>
</tbody>
</table>
<p>在阅读这些<code>Windows</code>操作系统下配置文件路径的时候需要注意一些事情：</p>
<ul>
<li>
<p>在给定的前三个路径中，配置文件可以使用<code>.ini</code>的扩展名，也可以使用<code>.cnf</code>的扩展名。</p>
</li>
<li>
<p><code>%WINDIR%</code>指的是你机器上<code>Windows</code>目录的位置，通常是<code>C:\WINDOWS</code>，如果你不确定，可以使用这个命令来查看：</p>
<pre><code class="hljs bash" lang="bash"><span class="hljs-built_in">echo</span> %WINDIR%
</code></pre></li>
<li>
<p><code>BASEDIR</code>指的是<code>MySQL</code>安装目录的路径，在我的<code>Windows</code>机器上的<code>BASEDIR</code>的值是：</p>
<pre><code class="hljs bash" lang="bash">C:\Program Files\MySQL\MySQL Server 5.7
</code></pre></li>
<li>
<p>第四个路径指的是我们在启动程序时可以通过指定<code>defaults-extra-file</code>参数的值来添加额外的配置文件路径，比方说我们在命令行上可以这么写：</p>
<pre><code class="hljs bash" lang="bash">mysqld --defaults-extra-file=C:\Users\xiaohaizi\my_extra_file.txt
</code></pre><p>这样<code>MySQL</code>服务器启动时就可以额外在<code>C:\Users\xiaohaizi\my_extra_file.txt</code>这个路径下查找配置文件。</p>
</li>
<li>
<p><code>%APPDATA%</code>表示<code>Windows</code>应用程序数据目录的值，可以使用下列命令查看：</p>
<pre><code class="hljs bash" lang="bash"><span class="hljs-built_in">echo</span> %APPDATA%
</code></pre></li>
<li>
<p>列表中最后一个名为<code>.mylogin.cnf</code>配置文件有点儿特殊，它不是一个纯文本文件（其他的配置文件都是纯文本文件），而是使用<code>mysql_config_editor</code>实用程序创建的加密文件。文件中只能包含一些用于启动客户端软件时连接服务器的一些选项，包括 <code>host</code>、<code>user</code>、<code>password</code>、<code>port</code>和 <code>socket</code>。而且它只能被客户端程序所使用。</p>
</li>
</ul>
<blockquote class="warning"><p>小贴士：

mysql_config_editor实用程序其实是MySQL安装目录下的bin目录下的一个可执行文件，这个实用程序有专用的语法来生成或修改 .mylogin.cnf 文件中的内容，如何使用这个程序不是我们讨论的主题，可以到MySQL的官方文档中查看。
</p></blockquote><h6 class="heading">类Unix操作系统中的配置文件</h6>
<p>在类<code>UNIX</code>操作系统中，<code>MySQL</code>会按照下列路径来寻找配置文件：</p>
<table>
<thead>
<tr>
<th>路径名</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/etc/my.cnf</code></td>
<td></td>
</tr>
<tr>
<td><code>/etc/mysql/my.cnf</code></td>
<td></td>
</tr>
<tr>
<td><code>SYSCONFDIR/my.cnf</code></td>
<td></td>
</tr>
<tr>
<td><code>$MYSQL_HOME/my.cnf</code></td>
<td>特定于服务器的选项（仅限服务器）</td>
</tr>
<tr>
<td><code>defaults-extra-file</code></td>
<td>命令行指定的额外配置文件路径</td>
</tr>
<tr>
<td><code>~/.my.cnf</code></td>
<td>用户特定选项</td>
</tr>
<tr>
<td><code>~/.mylogin.cnf</code></td>
<td>用户特定的登录路径选项（仅限客户端）</td>
</tr>
</tbody>
</table>
<p>在阅读这些<code>UNIX</code>操作系统下配置文件路径的时候需要注意一些事情：</p>
<ul>
<li>
<p><code>SYSCONFDIR</code>表示在使用<code>CMake</code>构建<code>MySQL</code>时使用<code>SYSCONFDIR</code>选项指定的目录。默认情况下，这是位于编译安装目录下的<code>etc</code>目录。</p>
<blockquote class="warning"><p>小贴士：

如果你不懂啥是个CMAKE，啥是个编译，那就跳过吧，对我们后续的文章没啥影响。
</p></blockquote></li>
<li>
<p><code>MYSQL_HOME</code>是一个环境变量，该变量的值是我们自己设置的，我们想设置就设置，不想设置就不设置。该变量的值代表一个路径，我们可以在该路径下创建一个<code>my.cnf</code>配置文件，那么这个配置文件中只能放置关于启动服务器程序相关的选项（言外之意就是其他的配置文件既能存放服务器相关的选项也能存放客户端相关的选项，<code>.mylogin.cnf</code>除外，它只能存放客户端相关的一些选项）。</p>
<blockquote class="warning"><p>小贴士：

如果大家使用mysqld_safe启动服务器程序，而且我们也没有主动设置这个MySQL_HOME环境变量的值，那这个环境变量的值将自动被设置为MySQL的安装目录，也就是MySQL服务器将会在安装目录下查找名为my.cnf配置文件（别忘了mysql.server会调用mysqld_safe，所以使用mysql.server启动服务器时也会在安装目录下查找配置文件）。
</p></blockquote></li>
<li>
<p>列表中的最后两个以<code>~</code>开头的路径是用户相关的，类<code>UNIX</code>
系统中都有一个当前登陆用户的概念，每个用户都可以有一个用户目录，<code>~</code>就代表这个用户目录，大家可以查看<code>HOME</code>环境变量的值来确定一下当前用户的用户目录，比方说我的<code>macOS</code>机器上的用户目录就是<code>/Users/xiaohaizi</code>。之所以说列表中最后两个配置文件是用户相关的，是因为不同的类<code>UNIX</code>系统的用户都可以在自己的用户目录下创建<code>.my.cnf</code>或者<code>.mylogin.cnf</code>，换句话说，不同登录用户使用的<code>.my.cnf</code>或者<code>.mylogin.cnf</code>配置文件是不同的。</p>
</li>
<li>
<p><code>defaults-extra-file</code>的含义与Windows中的一样。</p>
</li>
<li>
<p><code>.mylogin.cnf</code>的含义也同<code>Windows</code>中的一样，再次强调一遍，它不是纯文本文件，只能使用<code>mysql_config_editor</code>实用程序去创建或修改，用于存放客户端登陆服务器时的相关选项。</p>
</li>
</ul>
<p>这也就是说，在我的计算机中这几个路径中的<span style="color:red">任意一个</span>都可以当作配置文件来使用，如果它们不存在，你可以手动创建一个，比方说我手动在<code>~/.my.cnf</code>这个路径下创建一个配置文件。</p>
<p>另外，我们在唠叨如何启动<code>MySQL</code>服务器程序的时候说过，使用<code>mysqld_safe</code>程序启动服务器时，会间接调用<code>mysqld</code>，所以对于传递给<code>mysqld_safe</code>的启动选项来说，如果<code>mysqld_safe</code>程序不处理，会接着传递给<code>mysqld</code>程序处理。比方说<code>skip-networking</code>选项是由<code>mysqld</code>处理的，<code>mysqld_safe</code>并不处理，但是如果我们我们在命令行上这样执行：</p>
<pre><code class="hljs bash" lang="bash">mysqld_safe --skip-networking
</code></pre><p>则在<code>mysqld_safe</code>调用<code>mysqld</code>时，会把它处理不了的这个<code>skip-networking</code>选项交给<code>mysqld</code>处理。</p>
<h5 class="heading">配置文件的内容</h5>
<p>与在命令行中指定启动选项不同的是，配置文件中的启动选项被划分为若干个组，每个组有一个组名，用中括号<code>[]</code>扩起来，像这样：</p>
<pre><code class="hljs bash" lang="bash">[server]
(具体的启动选项...)

[mysqld]
(具体的启动选项...)

[mysqld_safe]
(具体的启动选项...)

[client]
(具体的启动选项...)

[mysql]
(具体的启动选项...)

[mysqladmin]
(具体的启动选项...)
</code></pre><p>像这个配置文件里就定义了许多个组，组名分别是<code>server</code>、<code>mysqld</code>、<code>mysqld_safe</code>、<code>client</code>、<code>mysql</code>、<code>mysqladmin</code>。每个组下边可以定义若干个启动选项，我们以<code>[server]</code>组为例来看一下填写启动选项的形式（其他组中启动选项的形式是一样的）：</p>
<pre><code class="hljs bash" lang="bash">[server]
option1     <span class="hljs-comment">#这是option1，该选项不需要选项值</span>
option2 = value2      <span class="hljs-comment">#这是option2，该选项需要选项值</span>
...
</code></pre><p>在配置文件中指定启动选项的语法类似于命令行语法，但是配置文件中只能使用长形式的选项。在配置文件中指定的启动选项不允许加<code>--</code>前缀，并且每行只指定一个选项，而且<code>=</code>周围可以有空白字符（命令行中选项名、<code>=</code>、选项值之间不允许有空白字符）。另外，在配置文件中，我们可以使用<code>#</code>来添加注释，从<code>#</code>出现直到行尾的内容都属于注释内容，读取配置文件时会忽略这些注释内容。为了大家更容易对比启动选项在命令行和配置文件中指定的区别，我们再把命令行中指定<code>option1</code>和<code>option2</code>两个选项的格式写一遍看看：</p>
<pre><code class="hljs bash" lang="bash">--option1 --option2=value2
</code></pre><p>配置文件中不同的选项组是给不同的启动命令使用的，如果选项组名称与程序名称相同，则组中的选项将专门应用于该程序。例如， <code>[mysqld]</code>和<code>[mysql]</code>组分别应用于<code>mysqld</code>服务器程序和<code>mysql</code>客户端程序。不过有两个选项组比较特别：</p>
<ul>
<li>
<p><code>[server]</code>组下边的启动选项将作用于所有的服务器程序。</p>
</li>
<li>
<p><code>[client]</code>组下边的启动选项将作用于所有的客户端程序。</p>
</li>
</ul>
<p>需要注意的一点是，<code>mysqld_safe</code>和<code>mysql.server</code>这两个程序在启动时都会读取<code>[mysqld]</code>选项组中的内容。为了直观感受一下，我们挑一些启动命令来看一下它们能读取的选项组都有哪些：</p>
<table>
<thead>
<tr>
<th style="text-align:center">启动命令</th>
<th style="text-align:center">类别</th>
<th style="text-align:center">能读取的组</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>mysqld</code></td>
<td style="text-align:center">启动服务器</td>
<td style="text-align:center"><code>[mysqld]</code>、<code>[server]</code></td>
</tr>
<tr>
<td style="text-align:center"><code>mysqld_safe</code></td>
<td style="text-align:center">启动服务器</td>
<td style="text-align:center"><code>[mysqld]</code>、<code>[server]</code>、<code>[mysqld_safe]</code></td>
</tr>
<tr>
<td style="text-align:center"><code>mysql.server</code></td>
<td style="text-align:center">启动服务器</td>
<td style="text-align:center"><code>[mysqld]</code>、<code>[server]</code>、<code>[mysql.server]</code></td>
</tr>
<tr>
<td style="text-align:center"><code>mysql</code></td>
<td style="text-align:center">启动客户端</td>
<td style="text-align:center"><code>[mysql]</code>、<code>[client]</code></td>
</tr>
<tr>
<td style="text-align:center"><code>mysqladmin</code></td>
<td style="text-align:center">启动客户端</td>
<td style="text-align:center"><code>[mysqladmin]</code>、<code>[client]</code></td>
</tr>
<tr>
<td style="text-align:center"><code>mysqldump</code></td>
<td style="text-align:center">启动客户端</td>
<td style="text-align:center"><code>[mysqldump]</code>、<code>[client]</code></td>
</tr>
</tbody>
</table>
<p>现在我们以<code>macOS</code>操作系统为例，在<code>/etc/mysql/my.cnf</code>这个配置文件中添加一些内容（<code>Windows</code>系统参考上边提到的配置文件路径）：</p>
<pre><code class="hljs bash" lang="bash">[server]
skip-networking
default-storage-engine=MyISAM
</code></pre><p>然后直接用<code>mysqld</code>启动服务器程序：</p>
<pre><code class="hljs bash" lang="bash">mysqld
</code></pre><p>虽然在命令行没有添加启动选项，但是在程序启动的时候，就会默认的到我们上边提到的配置文件路径下查找配置文件，其中就包括<code>/etc/mysql/my.cnf</code>。又由于<code>mysqld</code>命令可以读取<code>[server]</code>选项组的内容，所以<code>skip-networking</code>和<code>default-storage-engine=MyISAM</code>这两个选项是生效的。你可以把这些启动选项放在<code>[client]</code>组里再试试用<code>mysqld</code>启动服务器程序，看一下里边的启动选项生效不（剧透一下，不生效）。</p>
<blockquote class="warning"><p>小贴士：

如果我们想指定mysql.server程序的启动参数，则必须将它们放在配置文件中，而不是放在命令行中。mysql.server仅支持start和stop作为命令行参数。
</p></blockquote><h5 class="heading">特定MySQL版本的专用选项组</h5>
<p>我们可以在选项组的名称后加上特定的<code>MySQL</code>版本号，比如对于<code>[mysqld]</code>选项组来说，我们可以定义一个<code>[mysqld-5.7]</code>的选项组，它的含义和<code>[mysqld]</code>一样，只不过只有版本号为<code>5.7</code>的<code>mysqld</code>程序才能使用这个选项组中的选项。</p>
<h5 class="heading">配置文件的优先级</h5>
<p>我们前边唠叨过<code>MySQL</code>将在某些固定的路径下搜索配置文件，我们也可以通过在命令行上指定<code>defaults-extra-file</code>启动选项来指定额外的配置文件路径。<code>MySQL</code>将按照我们在上表中给定的顺序依次读取各个配置文件，如果该文件不存在则忽略。值得注意的是，<span style="color:red">如果我们在多个配置文件中设置了相同的启动选项，那以最后一个配置文件中的为准</span>。比方说<code>/etc/my.cnf</code>文件的内容是这样的：</p>
<pre><code class="hljs bash" lang="bash">[server]
default-storage-engine=InnoDB
</code></pre><p>而<code>~/.my.cnf</code>文件中的内容是这样的：</p>
<pre><code class="hljs bash" lang="bash">[server]
default-storage-engine=MyISAM
</code></pre><p>又因为<code>~/.my.cnf</code>比<code>/etc/my.cnf</code>顺序靠后，所以如果两个配置文件中出现相同的启动选项，以<code>~/.my.cnf</code>中的为准，所以<code>MySQL</code>服务器程序启动之后，<code>default-storage-engine</code>的值就是<code>MyISAM</code>。</p>
<h5 class="heading">同一个配置文件中多个组的优先级</h5>
<p>我们说同一个命令可以访问配置文件中的多个组，比如<code>mysqld</code>可以访问<code>[mysqld]</code>、<code>[server]</code>组，如果在同一个配置文件中，比如<code>~/.my.cnf</code>，在这些组里出现了同样的配置项，比如这样：</p>
<pre><code class="hljs bash" lang="bash">[server]
default-storage-engine=InnoDB

[mysqld]
default-storage-engine=MyISAM
</code></pre><p>那么，<span style="color:red">将以最后一个出现的组中的启动选项为准</span>，比方说例子中<code>default-storage-engine</code>既出现在<code>[mysqld]</code>组也出现在<code>[server]</code>组，因为<code>[mysqld]</code>组在<code>[server]</code>组后边，就以<code>[mysqld]</code>组中的配置项为准。</p>
<h5 class="heading">defaults-file的使用</h5>
<p>如果我们不想让<code>MySQL</code>到默认的路径下搜索配置文件（就是上表中列出的那些），可以在命令行指定<code>defaults-file</code>选项，比如这样（以<code>UNIX</code>系统为例）：</p>
<pre><code class="hljs bash" lang="bash">mysqld --defaults-file=/tmp/myconfig.txt
</code></pre><p>这样，在程序启动的时候将只在<code>/tmp/myconfig.txt</code>路径下搜索配置文件。如果文件不存在或无法访问，则会发生错误。</p>
<blockquote class="warning"><p>小贴士：

注意`defaults-extra-file`和`defaults-file`的区别，使用`defaults-extra-file`可以指定额外的配置文件搜索路径（也就是说那些固定的配置文件路径也会被搜索）。
</p></blockquote><h4 class="heading">命令行和配置文件中启动选项的区别</h4>
<p>在命令行上指定的绝大部分启动选项都可以放到配置文件中，但是有一些选项是专门为命令行设计的，比方说<code>defaults-extra-file</code>、<code>defaults-file</code>这样的选项本身就是为了指定配置文件路径的，再放在配置文件中使用就没啥意义了。剩下的一些只能用在命令行上而不能用到配置文件中的启动选项就不一一列举了，用到的时候再提哈（本书中基本用不到，有兴趣的到官方文档看哈）。</p>
<p>另外有一点需要特别注意，<span style="color:red">如果同一个启动选项既出现在命令行中，又出现在配置文件中，那么以命令行中的启动选项为准</span>！比如我们在配置文件中写了：</p>
<pre><code class="hljs bash" lang="bash">[server]
default-storage-engine=InnoDB
</code></pre><p>而我们的启动命令是：</p>
<pre><code class="hljs bash" lang="bash">mysql.server start --default-storage-engine=MyISAM
</code></pre><p>那最后<code>default-storage-engine</code>的值就是<code>MyISAM</code>！</p>
<h3 class="heading">系统变量</h3>
<h4 class="heading">系统变量简介</h4>
<p><code>MySQL</code>服务器程序运行过程中会用到许多影响程序行为的变量，它们被称为<code>MySQL</code>系统变量，比如允许同时连入的客户端数量用系统变量<code>max_connections</code>表示，表的默认存储引擎用系统变量<code>default_storage_engine</code>表示，查询缓存的大小用系统变量<code>query_cache_size</code>表示，<code>MySQL</code>服务器程序的系统变量有好几百条，我们就不一一列举了。每个系统变量都有一个默认值，我们可以使用命令行或者配置文件中的选项在启动服务器时改变一些系统变量的值。大多数的系统变量的值也可以在程序运行过程中修改，而无需停止并重新启动它。</p>
<h4 class="heading">查看系统变量</h4>
<p>我们可以使用下列命令查看<code>MySQL</code>服务器程序支持的系统变量以及它们的当前值：</p>
<pre><code class="hljs bash" lang="bash">SHOW VARIABLES [LIKE 匹配的模式];
</code></pre><p>由于<code>系统变量</code>实在太多了，如果我们直接使用<code>SHOW VARIABLES</code>查看的话就直接刷屏了，所以通常都会带一个<code>LIKE</code>过滤条件来查看我们需要的系统变量的值，比方说这么写：</p>
<pre><code class="hljs bash" lang="bash">mysql&gt; SHOW VARIABLES LIKE <span class="hljs-string">'default_storage_engine'</span>;
+------------------------+--------+
| Variable_name          | Value  |
+------------------------+--------+
| default_storage_engine | InnoDB |
+------------------------+--------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)

mysql&gt; SHOW VARIABLES like <span class="hljs-string">'max_connections'</span>;
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| max_connections | 151   |
+-----------------+-------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
</code></pre><p>可以看到，现在服务器程序使用的默认存储引擎就是<code>InnoDB</code>，允许同时连接的客户端数量最多为<code>151</code>。别忘了<code>LIKE</code>表达式后边可以跟通配符来进行模糊查询，也就是说我们可以这么写：</p>
<pre><code class="hljs bash" lang="bash">mysql&gt; SHOW VARIABLES LIKE <span class="hljs-string">'default%'</span>;
+-------------------------------+-----------------------+
| Variable_name                 | Value                 |
+-------------------------------+-----------------------+
| default_authentication_plugin | mysql_native_password |
| default_password_lifetime     | 0                     |
| default_storage_engine        | InnoDB                |
| default_tmp_storage_engine    | InnoDB                |
| default_week_format           | 0                     |
+-------------------------------+-----------------------+
5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)

mysql&gt;
</code></pre><p>这样就查出了所有以<code>default</code>开头的系统变量的值。</p>
<h4 class="heading">设置系统变量</h4>
<h5 class="heading">通过启动选项设置</h5>
<p>大部分的<code>系统变量</code>都可以通过启动服务器时传送启动选项的方式来进行设置。如何填写启动选项我们上边已经花了大篇幅来唠叨了，就是下边两种方式：</p>
<ul>
<li>
<p>通过命令行添加启动选项。</p>
<p>比方说我们在启动服务器程序时用这个命令：</p>
<pre><code class="hljs bash" lang="bash">mysqld --default-storage-engine=MyISAM --max-connections=10
</code></pre></li>
<li>
<p>通过配置文件添加启动选项。</p>
<p>我们可以这样填写配置文件：</p>
<pre><code class="hljs bash" lang="bash">[server]
default-storage-engine=MyISAM
max-connections=10
</code></pre></li>
</ul>
<p>当使用上边两种方式中的任意一种启动服务器程序后，我们再来查看一下系统变量的值：</p>
<pre><code class="hljs bash" lang="bash">mysql&gt; SHOW VARIABLES LIKE <span class="hljs-string">'default_storage_engine'</span>;
+------------------------+--------+
| Variable_name          | Value  |
+------------------------+--------+
| default_storage_engine | MyISAM |
+------------------------+--------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

mysql&gt; SHOW VARIABLES LIKE <span class="hljs-string">'max_connections'</span>;
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| max_connections | 10    |
+-----------------+-------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

mysql&gt;
</code></pre><p>可以看到<code>default_storage_engine</code>和<code>max_connections</code>这两个系统变量的值已经被修改了。有一点需要注意的是，<span style="color:red">对于启动选项来说，如果启动选项名由多个单词组成，各个单词之间用短划线<code>-</code>或者下划线<code>_</code>连接起来都可以，但是对应的系统变量之间必须使用下划线<code>_</code>连接起来</span>。</p>
<h5 class="heading">服务器程序运行过程中设置</h5>
<p><code>系统变量</code>比较牛逼的一点就是，<span style="color:red">对于大部分系统变量来说，它们的值可以在服务器程序运行过程中进行动态修改而无需停止并重启服务器</span>。不过系统变量有作用范围之分，下边详细唠叨下。</p>
<h6 class="heading">设置不同作用范围的系统变量</h6>
<p>我们前边说过，多个客户端程序可以同时连接到一个服务器程序。对于同一个系统变量，我们有时想让不同的客户端有不同的值。比方说狗哥使用客户端A，他想让当前客户端对应的默认存储引擎为<code>InnoDB</code>，所以他可以把系统变量<code>default_storage_engine</code>的值设置为<code>InnoDB</code>；猫爷使用客户端B，他想让当前客户端对应的默认存储引擎为<code>MyISAM</code>，所以他可以把系统变量<code>default_storage_engine</code>的值设置为<code>MyISAM</code>。这样可以使狗哥和猫爷的的客户端拥有不同的默认存储引擎，使用时互不影响，十分方便。但是这样各个客户端都私有一份系统变量会产生这么两个问题：</p>
<ul>
<li>
<p>有一些系统变量并不是针对单个客户端的，比如允许同时连接到服务器的客户端数量<code>max_connections</code>，查询缓存的大小<code>query_cache_size</code>，这些公有的系统变量让某个客户端私有显然不合适。</p>
</li>
<li>
<p>一个新连接到服务器的客户端对应的系统变量的值该怎么设置？</p>
</li>
</ul>
<p>为了解决这两个问题，设计<code>MySQL</code>的大叔提出了系统变量的<code>作用范围</code>的概念，具体来说<code>作用范围</code>分为这两种：</p>
<ul>
<li>
<p><code>GLOBAL</code>：全局变量，影响服务器的整体操作。</p>
</li>
<li>
<p><code>SESSION</code>：会话变量，影响某个客户端连接的操作。（注：<code>SESSION</code>有个别名叫<code>LOCAL</code>）</p>
</li>
</ul>
<p>在服务器启动时，会将每个全局变量初始化为其默认值（可以通过命令行或选项文件中指定的选项更改这些默认值）。然后服务器还为每个连接的客户端维护一组会话变量，客户端的会话变量在连接时使用相应全局变量的当前值初始化。</p>
<p>这话有点儿绕，还是以<code>default_storage_engine</code>举例，在服务器启动时会初始化一个名为<code>default_storage_engine</code>，作用范围为<code>GLOBAL</code>的系统变量。之后每当有一个客户端连接到该服务器时，服务器都会单独为该客户端分配一个名为<code>default_storage_engine</code>，作用范围为<code>SESSION</code>的系统变量，该作用范围为<code>SESSION</code>的系统变量值按照当前作用范围为<code>GLOBAL</code>的同名系统变量值进行初始化。</p>
<p>很显然，<span style="color:red">通过启动选项设置的系统变量的作用范围都是<code>GLOBAL</code>的，也就是对所有客户端都有效的</span>，因为在系统启动的时候还没有客户端程序连接进来呢。了解了系统变量的<code>GLOBAL</code>和<code>SESSION</code>作用范围之后，我们再看一下在服务器程序运行期间通过客户端程序设置系统变量的语法：</p>
<pre><code class="hljs bash" lang="bash">SET [GLOBAL|SESSION] 系统变量名 = 值;
</code></pre><p>或者写成这样也行：</p>
<pre><code class="hljs bash" lang="bash">SET [@@(GLOBAL|SESSION).]var_name = XXX;
</code></pre><p>比如我们想在服务器运行过程中把作用范围为<code>GLOBAL</code>的系统变量<code>default_storage_engine</code>的值修改为<code>MyISAM</code>，也就是想让之后新连接到服务器的客户端都用<code>MyISAM</code>作为默认的存储引擎，那我们可以选择下边两条语句中的任意一条来进行设置：</p>
<pre><code class="hljs bash" lang="bash">语句一：SET GLOBAL default_storage_engine = MyISAM;
语句二：SET @@GLOBAL.default_storage_engine = MyISAM;
</code></pre><p>如果只想对本客户端生效，也可以选择下边三条语句中的任意一条来进行设置：</p>
<pre><code class="hljs bash" lang="bash">语句一：SET SESSION default_storage_engine = MyISAM;
语句二：SET @@SESSION.default_storage_engine = MyISAM;
语句三：SET default_storage_engine = MyISAM;
</code></pre><p>从上边的<code>语句三</code>也可以看出，<span style="color:red">如果在设置系统变量的语句中省略了作用范围，默认的作用范围就是<code>SESSION</code></span>。也就是说<code>SET 系统变量名 = 值</code>和<code>SET SESSION 系统变量名 = 值</code>是等价的。</p>
<h6 class="heading">查看不同作用范围的系统变量</h6>
<p>既然<code>系统变量</code>有<code>作用范围</code>之分，那我们的<code>SHOW VARIABLES</code>语句查看的是什么<code>作用范围</code>的<code>系统变量</code>呢？</p>
<p>答：默认查看的是<code>SESSION</code>作用范围的系统变量。</p>
<p>当然我们也可以在查看系统变量的语句上加上要查看哪个<code>作用范围</code>的系统变量，就像这样：</p>
<pre><code class="hljs bash" lang="bash">SHOW [GLOBAL|SESSION] VARIABLES [LIKE 匹配的模式];
</code></pre><p>下边我们演示一下完整的设置并查看系统变量的过程：</p>
<pre><code class="hljs bash" lang="bash">mysql&gt; SHOW SESSION VARIABLES LIKE <span class="hljs-string">'default_storage_engine'</span>;
+------------------------+--------+
| Variable_name          | Value  |
+------------------------+--------+
| default_storage_engine | InnoDB |
+------------------------+--------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

mysql&gt; SHOW GLOBAL VARIABLES LIKE <span class="hljs-string">'default_storage_engine'</span>;
+------------------------+--------+
| Variable_name          | Value  |
+------------------------+--------+
| default_storage_engine | InnoDB |
+------------------------+--------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

mysql&gt; SET SESSION default_storage_engine = MyISAM;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SHOW SESSION VARIABLES LIKE <span class="hljs-string">'default_storage_engine'</span>;
+------------------------+--------+
| Variable_name          | Value  |
+------------------------+--------+
| default_storage_engine | MyISAM |
+------------------------+--------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

mysql&gt; SHOW GLOBAL VARIABLES LIKE <span class="hljs-string">'default_storage_engine'</span>;
+------------------------+--------+
| Variable_name          | Value  |
+------------------------+--------+
| default_storage_engine | InnoDB |
+------------------------+--------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

mysql&gt;
</code></pre><p>可以看到，最初<code>default_storage_engine</code>的系统变量无论是在<code>GLOBAL</code>作用范围上还是在<code>SESSION</code>作用范围上的值都是<code>InnoDB</code>，我们在<code>SESSION</code>作用范围把它的值设置为<code>MyISAM</code>之后，可以看到<code>GLOBAL</code>作用范围的值并没有改变。</p>
<blockquote class="warning"><p>小贴士：

如果某个客户端改变了某个系统变量在`GLOBAL`作用范围的值，并不会影响该系统变量在当前已经连接的客户端作用范围为`SESSION`的值，只会影响后续连入的客户端在作用范围为`SESSION`的值。
</p></blockquote><h6 class="heading">注意事项</h6>
<ul>
<li>
<p><span style="color:red">并不是所有系统变量都具有<code>GLOBAL</code>和<code>SESSION</code>的作用范围</span>。</p>
<ul>
<li>
<p>有一些系统变量只具有<code>GLOBAL</code>作用范围，比方说<code>max_connections</code>，表示服务器程序支持同时最多有多少个客户端程序进行连接。</p>
</li>
<li>
<p>有一些系统变量只具有<code>SESSION</code>作用范围，比如<code>insert_id</code>，表示插入值时使用的<code>AUTO_INCREMENT</code>修饰的列的值。</p>
</li>
<li>
<p>有一些系统变量的值既具有<code>GLOBAL</code>作用范围，也具有<code>SESSION</code>作用范围，比如我们前边用到的<code>default_storage_engine</code>，而且其实大部分的系统变量都是这样的，</p>
</li>
</ul>
</li>
<li>
<p><span style="color:red">有些系统变量是只读的，并不能设置值</span>。</p>
<p>比方说<code>version</code>，表示当前<code>MySQL</code>的版本，我们客户端是不能设置它的值的，只能在<code>SHOW VARIABLES</code>语句里查看。</p>
</li>
</ul>
<h4 class="heading">启动选项和系统变量的区别</h4>
<p><code>启动选项</code>是在程序启动时我们程序员传递的一些参数，而<code>系统变量</code>是影响服务器程序运行行为的变量，它们之间的关系如下：</p>
<ul>
<li>
<p>大部分的系统变量都可以被当作启动选项传入。</p>
</li>
<li>
<p>有些系统变量是在程序运行过程中自动生成的，是不可以当作启动选项来设置，比如<code>auto_increment_offset</code>、<code>character_set_client</code>啥的。</p>
</li>
<li>
<p>有些启动选项也不是系统变量，比如<code>defaults-file</code>。</p>
</li>
</ul>
<h3 class="heading">状态变量</h3>
<p>为了让我们更好的了解服务器程序的运行情况，<code>MySQL</code>服务器程序中维护了好多关于程序运行状态的变量，它们被称为<code>状态变量</code>。比方说<code>Threads_connected</code>表示当前有多少客户端与服务器建立了连接，<code>Handler_update</code>表示已经更新了多少行记录吧啦吧啦，像这样显示服务器程序状态信息的<code>状态变量</code>还有好几百个，我们就不一一唠叨了，等遇到了会详细说它们的作用的。</p>
<p>由于<code>状态变量</code>是用来显示服务器程序运行状况的，所以<span style="color:red">它们的值只能由服务器程序自己来设置，我们程序员是不能设置的</span>。与<code>系统变量</code>类似，<code>状态变量</code>也有<code>GLOBAL</code>和<code>SESSION</code>两个作用范围的，所以查看<code>状态变量</code>的语句可以这么写：</p>
<pre><code class="hljs bash" lang="bash">SHOW [GLOBAL|SESSION] STATUS [LIKE 匹配的模式];
</code></pre><p>类似的，如果我们不写明作用范围，默认的作用范围是<code>SESSION</code>，比方说这样：</p>
<pre><code class="hljs bash" lang="bash">mysql&gt; SHOW STATUS LIKE <span class="hljs-string">'thread%'</span>;
+-------------------+-------+
| Variable_name     | Value |
+-------------------+-------+
| Threads_cached    | 0     |
| Threads_connected | 1     |
| Threads_created   | 1     |
| Threads_running   | 1     |
+-------------------+-------+
4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

mysql&gt;
</code></pre><p>所有以<code>Thread</code>开头的<code>SESSION</code>作用范围的状态变量就都被展示出来了。</p>
